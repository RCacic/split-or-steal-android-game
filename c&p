import re
import serial
import pymysql

PORT = "/dev/ttyACM0"   # change to /dev/ttyUSB0 if needed
BAUD = 9600


conn = pymysql.connect(
    host="localhost",
    user="pi",
    password="",
    database="door_db",
    autocommit=True
)

ser = serial.Serial(PORT, BAUD, timeout=1)


last_knock_count = None
last_accepted = None

print("Logging Arduino serial -> MariaDB (Ctrl+C to stop)")
with conn.cursor() as cur:
    while True:
        line = ser.readline().decode(errors="ignore").strip()
        if not line:
            continue

        print(line)

       
        m = re.search(r"COUNT,(\d+),ACCEPTED,(\d+)", line)
        if m:
            last_knock_count = int(m.group(1))
            last_accepted = int(m.group(2))

       
        if line == "BTN,ACCEPTED":
            last_accepted = 1

       
        event_type = None
        if line.startswith("EVENT,"):
            event_type = line.split(",", 1)[1]

        cur.execute(
            "INSERT INTO door_log (raw_line, event_type, knock_count, accepted) VALUES (%s, %s, %s, %s)",
            (line, event_type, last_knock_count, last_accepted)
        )
