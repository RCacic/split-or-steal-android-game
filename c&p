import serial
import time
import paho.mqtt.client as mqtt

SERIAL_PORT = "/dev/ttyACM0"   # change if yours differs
BAUD = 9600

BROKER = "localhost"
TOPIC = "greenhouse/soil/moisture"

# Tweak these based on your sensor behaviour
DRY_ON = 400
WET_OFF = 450

pump_state = "OFF"

client = mqtt.Client()
client.connect(BROKER, 1883, 60)

ser = serial.Serial(SERIAL_PORT, BAUD, timeout=1)
time.sleep(2)  # let Arduino reset

print("Connected. Reading soil + publishing MQTT...")

while True:
    line = ser.readline().decode("utf-8", errors="ignore").strip()

    if not line:
        continue

    # debug print
    print("SERIAL:", line)

    # Expected: SOIL:123
    if line.startswith("SOIL:"):
        try:
            soil_value = int(line.split(":")[1])
        except:
            continue

        # Publish MQTT
        client.publish(TOPIC, str(soil_value))
        print("MQTT ->", TOPIC, soil_value)

        # Rule + hysteresis
        if pump_state == "OFF" and soil_value < DRY_ON:
            ser.write(b"PUMP_ON\n")
            pump_state = "ON"
            print("RULE: soil dry -> PUMP_ON")

        elif pump_state == "ON" and soil_value > WET_OFF:
            ser.write(b"PUMP_OFF\n")
            pump_state = "OFF"
            print("RULE: soil wet -> PUMP_OFF")

    time.sleep(0.05)
