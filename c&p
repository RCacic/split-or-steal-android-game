#!/usr/bin/env python3
import time
import json
import serial
import paho.mqtt.client as mqtt

SERIAL_PORT = "/dev/ttyACM0"
BAUD = 9600

TB_HOST = "mqtt.thingsboard.cloud"
TB_PORT = 1883
ACCESS_TOKEN = "YOUR_DEVICE_TOKEN"

TELEMETRY_TOPIC = "v1/devices/me/telemetry"
ATTRIBUTES_TOPIC = "v1/devices/me/attributes"
RPC_SUB_TOPIC = "v1/devices/me/rpc/request/+"

DRY_ON_LEVEL = 4
WET_OFF_LEVEL = 1

hose_state = "OFF"
auto_enabled = True

def parse_line(line):
    if not line.startswith("SOIL:"):
        return None
    parts = line.split(",")
    level = int(parts[0].split(":")[1])
    raw = int(parts[1].split(":")[1])
    return level, raw

def main():
    global hose_state, auto_enabled

    ser = serial.Serial(SERIAL_PORT, BAUD, timeout=1)
    time.sleep(2)

    client = mqtt.Client()
    client.username_pw_set(ACCESS_TOKEN)
    client.connect(TB_HOST, TB_PORT, 60)

    def on_message(client, userdata, msg):
        global hose_state, auto_enabled
        payload = json.loads(msg.payload.decode())
        method = payload.get("method")

        req_id = msg.topic.split("/")[-1]
        resp_topic = f"v1/devices/me/rpc/response/{req_id}"

        if method == "hose_on":
            ser.write(b"HOSE_ON\n")
            hose_state = "ON"
            auto_enabled = False
            client.publish(resp_topic, json.dumps(True))

        elif method == "hose_off":
            ser.write(b"HOSE_OFF\n")
            hose_state = "OFF"
            auto_enabled = False
            client.publish(resp_topic, json.dumps(True))

    client.subscribe(RPC_SUB_TOPIC)
    client.on_message = on_message
    client.loop_start()

    while True:
        line = ser.readline().decode(errors="ignore").strip()
        parsed = parse_line(line)
        if not parsed:
            continue

        level, raw = parsed

        if auto_enabled:
            if hose_state == "OFF" and level >= DRY_ON_LEVEL:
                hose_state = "ON"
                ser.write(b"HOSE_ON\n")
            elif hose_state == "ON" and level <= WET_OFF_LEVEL:
                hose_state = "OFF"
                ser.write(b"HOSE_OFF\n")

        telemetry = {
            "soil_level": level,
            "soil_raw": raw,
            "hose_state": hose_state,
            "auto_enabled": auto_enabled
        }

        client.publish(TELEMETRY_TOPIC, json.dumps(telemetry))
        client.publish(ATTRIBUTES_TOPIC, json.dumps({
            "hose_state": hose_state,
            "auto_enabled": auto_enabled
        }))

        time.sleep(1)

if __name__ == "__main__":
    main()
