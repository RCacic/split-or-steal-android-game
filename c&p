import serial
import time
import json
import paho.mqtt.client as mqtt

SERIAL_PORT = "/dev/ttyACM0"
BAUD = 9600

MQTT_HOST = "localhost"
MQTT_PORT = 1883
TOPIC = "greenhouse/soil/moisture"

ser = serial.Serial(SERIAL_PORT, BAUD, timeout=1)
client = mqtt.Client()
client.connect(MQTT_HOST, MQTT_PORT, 60)

print("Reading serial -> publishing MQTT (Ctrl+C to stop)")

while True:
    line = ser.readline().decode(errors="ignore").strip()
    if not line:
        continue

    # Expecting: SOIL:123
    if line.startswith("SOIL:"):
        value = int(line.split(":")[1])
        payload = {"soil": value, "zone": 1, "ts": time.time()}
        client.publish(TOPIC, json.dumps(payload))
        print("PUB", payload)
